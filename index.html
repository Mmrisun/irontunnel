<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>IronTunnel - магазин оружия</title>
<style>
  /* Добавь сюда свои стили */
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

</head>
<body>

<!-- Кнопки для входа/регистрации -->
<button id="btn-register">Регистрация</button>
<button id="btn-login">Вход</button>
<button id="btn-google-login">Войти через Google</button>

<div id="user-info" style="display:none;">
  <span id="username-display"></span>
  <button id="btn-logout">Выйти</button>
  <button id="btn-change-pass">Сменить пароль</button>
</div>

<!-- Остальной твой HTML... -->

<script>
  // Твой существующий код...
  let cart = [];
  let loggedUser = null;
  let weapons = [
    // твой список оружия
  ];
  let filteredCategory = null;
  let searchTerm = "";

  function renderCart() {
    const cartItems = document.getElementById("cart-items");
    cartItems.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
      const weapon = weapons.find(w => w.id === item.id);
      total += weapon.price * item.count;

      const li = document.createElement("li");
      li.textContent = `${weapon.name} × ${item.count}`;
      const btnRemove = document.createElement("button");
      btnRemove.setAttribute("aria-label", `Удалить ${weapon.name} из корзины`);
      btnRemove.textContent = "×";
      btnRemove.addEventListener("click", () => {
        removeFromCart(item.id);
      });
      li.appendChild(btnRemove);
      cartItems.appendChild(li);
    });

    document.getElementById("cart-total").textContent = total;
  }

  function addToCart(id) {
    const item = cart.find(c => c.id === id);
    if (item) {
      item.count++;
    } else {
      cart.push({ id: id, count: 1 });
    }
    saveCart();
    renderCart();
  }

  function removeFromCart(id) {
    cart = cart.filter(c => c.id !== id);
    saveCart();
    renderCart();
  }

  function clearCart() {
    if (!loggedUser) {
      alert("Пожалуйста, войдите в аккаунт, чтобы очистить корзину.");
      return;
    }
    cart = [];
    saveCart();
    renderCart();
  }

  function saveCart() {
    if (loggedUser) {
      localStorage.setItem(`cart_${loggedUser.username}`, JSON.stringify(cart));
    }
  }

  function loadCart() {
    if (loggedUser) {
      const saved = localStorage.getItem(`cart_${loggedUser.username}`);
      if (saved) {
        cart = JSON.parse(saved);
      } else {
        cart = [];
      }
    } else {
      cart = [];
    }
    renderCart();
  }

  function saveUsers(users) {
    localStorage.setItem("users", JSON.stringify(users));
  }
  function loadUsers() {
    const users = localStorage.getItem("users");
    return users ? JSON.parse(users) : {};
  }

  function login(username, password) {
    const users = loadUsers();
    if (users[username] && users[username] === password) {
      loggedUser = { username, password };
      localStorage.setItem("loggedUser", JSON.stringify(loggedUser));
      loadCart();
      updateUIForLogin();
      return true;
    }
    return false;
  }

  function logout() {
    loggedUser = null;
    localStorage.removeItem("loggedUser");
    cart = [];
    renderCart();
    updateUIForLogout();
  }

  function register(username, password) {
    const users = loadUsers();
    if (users[username]) {
      return false;
    }
    users[username] = password;
    saveUsers(users);
    return true;
  }

  function checkLoggedUser() {
    const saved = localStorage.getItem("loggedUser");
    if (saved) {
      loggedUser = JSON.parse(saved);
      loadCart();
      updateUIForLogin();
    } else {
      updateUIForLogout();
      renderCart();
    }
  }

  function updateUIForLogin() {
    document.getElementById("btn-register").style.display = "none";
    document.getElementById("btn-login").style.display = "none";
    document.getElementById("btn-google-login").style.display = "none";
    document.getElementById("user-info").style.display = "flex";
    document.getElementById("username-display").textContent = loggedUser.username;
  }

  function updateUIForLogout() {
    document.getElementById("btn-register").style.display = "inline-block";
    document.getElementById("btn-login").style.display = "inline-block";
    document.getElementById("btn-google-login").style.display = "inline-block";
    document.getElementById("user-info").style.display = "none";
    cart = [];
    renderCart();
  }

  function changePassword(oldPass, newPass) {
    if (!loggedUser) return false;
    if (loggedUser.password !== oldPass) return false;
    const users = loadUsers();
    users[loggedUser.username] = newPass;
    saveUsers(users);
    loggedUser.password = newPass;
    localStorage.setItem("loggedUser", JSON.stringify(loggedUser));
    return true;
  }

  // ==== Firebase Google Auth добавлен сюда ====

  const firebaseConfig = {
    apiKey: "AIzaSyDyMkuK1bt8ikMOz5AbauQb6T5L07REYVY",
    authDomain: "irontunnel-f0f72.firebaseapp.com",
    projectId: "irontunnel-f0f72",
    storageBucket: "irontunnel-f0f72.appspot.com",
    messagingSenderId: "1081872652770",
    appId: "1:1081872652770:web:916a9303a9f1f0cfe401bb",
    measurementId: "G-3CZ8TX2Y4F"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .then(result => {
        const user = result.user;
        const username = user.email.split('@')[0];
        const users = loadUsers();

        // Если пользователь через Google — добавляем без пароля
        if (!users[username]) {
          users[username] = "";
          saveUsers(users);
        }

        loggedUser = { username, password: "" };
        localStorage.setItem("loggedUser", JSON.stringify(loggedUser));

        loadCart();
        updateUIForLogin();
        alert('Привет, ' + user.displayName);
      })
      .catch(error => {
        alert('Ошибка: ' + error.message);
      });
  }

  // ==== Обработчики ====

  window.addEventListener("DOMContentLoaded", () => {
    // Здесь вызов renderWeapons(), checkLoggedUser() и прочего твоего кода
    checkLoggedUser();

    // Кнопка входа через Google
    document.getElementById("btn-google-login").addEventListener("click", signInWithGoogle);

    // Другие обработчики — регистрация, вход, выход, смена пароля и т.п.
    // Добавь сюда свои обработчики, если надо
  });

</script>

</body>
</html>
